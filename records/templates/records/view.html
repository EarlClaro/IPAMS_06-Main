{% extends 'ipams/base.html' %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% block footer %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<style>
.action-buttons {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.action-buttons > a,
.action-buttons > button {
    margin-left: 10px;
    width: 100%;
}

.action-buttons > a > button,
.action-buttons > button {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@keyframes nalcModalAnimation {
    from {
        transform: scale(0);
        opacity: 0;
        transform-origin: bottom right;
    }
    to {
        transform: scale(1);
        opacity: 1;
        transform-origin: bottom right;
    }
}

@keyframes popupAnimation {
    0% {
        transform: translateY(100%) scale(0);
        opacity: 0;
    }
    100% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

#nalcSummaryModal .modal-dialog,
#nalcCiteModal .modal-dialog {
    animation-name: nalcModalAnimation;
    animation-duration: 0.5s;
}

#nalcSummaryModal,
#nalcCiteModal {
    z-index: 1055;
}

.website-title{
        font-size: 42px;
        font-weight: bold;
		line-height: 1;
    }

	.website-description{
		margin-left: -10px;
	}


	/* Import Google font - Poppins */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

.chatbot-toggler {
  position: fixed;
  bottom: 30px;
  right: 35px;
  outline: none;
  border: none;
  height: 80px;
  width: 80px;
  display: flex;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: gold;
  transition: all 0.2s ease;
}
body.show-chatbot .chatbot-toggler {
  transform: rotate(90deg);
}
.chatbot-toggler span {
  color: #fff;
  position: absolute;
}
.chatbot-toggler span:last-child,
body.show-chatbot .chatbot-toggler span:first-child  {
  opacity: 0;
}
body.show-chatbot .chatbot-toggler span:last-child {
  opacity: 1;
}
.chatbot {
  position: fixed;
  right: 35px;
  bottom: 90px;
  width: 420px;
  background: #fff;
  border-radius: 15px;
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
  transform: scale(0.5);
  transform-origin: bottom right;
  box-shadow: 0 0 128px 0 rgba(0,0,0,0.1),
              0 32px 64px -48px rgba(0,0,0,0.5);
  transition: all 0.1s ease;
}
body.show-chatbot .chatbot {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}
.chatbot header {
  padding: 16px 0;
  position: relative;
  text-align: center;
  color: #fff;
  background: gold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.chatbot header span {
  position: absolute;
  right: 15px;
  top: 50%;
  display: none;
  cursor: pointer;
  transform: translateY(-50%);
}
header h2 {
  font-size: 1.4rem;
}
.chatbot .chatbox {
  overflow-y: auto;
  height: 410px;
  padding: 30px 20px 100px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar {
  width: 6px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-track {
  background: #fff;
  border-radius: 25px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 25px;
}
.chatbox .chat {
  display: flex;
  list-style: none;
}
.chatbox .outgoing {
  margin: 20px 0;
  justify-content: flex-end;
}
.chatbox .incoming span {
  width: 32px;
  height: 32px;
  color: #fff;
  cursor: default;
  text-align: center;
  line-height: 32px;
  align-self: flex-end;
  background: gold;
  border-radius: 4px;
  margin: 0 10px 7px 0;
}
.chatbox .chat p {
  white-space: pre-wrap;
  padding: 12px 16px;
  border-radius: 10px 10px 0 10px;
  max-width: 75%;
  color: #fff;
  font-size: 0.95rem;
  background: gold;
}
.chatbox .incoming p {
  border-radius: 10px 10px 10px 0;
}
.chatbox .chat p.error {
  color: #721c24;
  background: #f8d7da;
}
.chatbox .incoming p {
  color: #000;
  background: #f2f2f2;
}
.chatbot .chat-input {
  display: flex;
  gap: 5px;
  position: absolute;
  bottom: 0;
  width: 100%;
  background: #fff;
  padding: 3px 20px;
  border-top: 1px solid #ddd;
}
.chat-input textarea {
  height: 55px;
  width: 100%;
  border: none;
  outline: none;
  resize: none;
  max-height: 180px;
  padding: 15px 15px 15px 0;
  font-size: 0.95rem;
}
.chat-input span {
  align-self: flex-end;
  color: gold;
  cursor: pointer;
  height: 55px;
  display: flex;
  align-items: center;
  visibility: hidden;
  font-size: 1.35rem;
}
.chat-input textarea:valid ~ span {
  visibility: visible;
}
@media (max-width: 490px) {
  .chatbot-toggler {
    right: 20px;
    bottom: 20px;
  }
  .chatbot {
    right: 0;
    bottom: 0;
    height: 100%;
    border-radius: 0;
    width: 100%;
  }
  .chatbot .chatbox {
    height: 90%;
    padding: 25px 15px 100px;
  }
  .chatbot .chat-input {
    padding: 5px 15px;
  }
  .chatbot header span {
    display: block;
  }
}

.summary-popup {
    position: fixed;
    bottom: 160px; /* Adjust this value so that the popup appears above the NALC button */
    right: 20px; /* This should be the same as the NALC button to align it to the right */
    width: 320px;
    background-color: #FFD700;
    border: 1px solid #8B0000;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    display: none;
    font-family: Arial, sans-serif;
    font-size: 16px;
    z-index: 1030; /* Adjust if necessary to ensure proper stacking */
    opacity: 0;
    transform: scale(0);
    transition: transform 0.3s, opacity 0.3s; /* Smooth transition for transform and opacity */
    /* No need for calc() function since we're going back to fixed positioning */
    padding: 30px 20px 20px;
}

.summary-text {
    border: 1px solid #8B0000; /* Example border color, adjust as needed */
    padding: 10px; /* Spacing inside the border */
    margin-top: 10px; /* Spacing outside the border, adjust as needed */
    margin-bottom: 10px; /* Spacing outside the border, adjust as needed */
    background-color: #ffffff; /* Optional: change background color inside the border */
    color: #000000; /* Optional: change text color */
    border-radius: 5px; /* Optional: if you want rounded corners */
    overflow: auto; /* Ensures content is contained within the border if it overflows */
}

.summary-header {
    font-size: 20px;
    font-weight: bold;
    color: #8B0000;
}

.close-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 24px;
    color: #8B0000;
}

.chatbot-popup {
	position: fixed;
	bottom: 120px;
	right: 20px;
	width: 300px;
	background-color: #fff;
	border: 1px solid #ccc;
	border-radius: 5px;
	padding: 10px;
	box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
	}

	.chatbot-header {
	font-size: 18px;
	font-weight: bold;
	margin-bottom: 10px;
	}

	.chatbot-messages {
	height: 200px;
	overflow-y: auto;
	border: 1px solid #ccc;
	padding: 5px;
	margin-bottom: 10px;
	}

	.chatbot-input {
	width: calc(100% - 22px);
	padding: 8px;
	border: 1px solid #ccc;
	border-radius: 5px;
	margin-right: 10px;
	}
</style>

<script>
$(document).ready(function(){
    $('#abstract_content').bind('copy paste contextmenu',function(e) {
        e.preventDefault();
        return false;
    });

    $('.download').click(function(event) {
        event.preventDefault();
        var recordID = $(this).data('record-id');
        var userID = $(this).data('user-id');
        Swal.fire({
            type: 'info',
            title: 'Authentication PIN',
            text: 'Click the button to generate a PIN to your email',
            showCancelButton: true,
            confirmButtonText: 'Send PIN',
            cancelButtonText: 'Cancel',
            cancelButtonColor: '#808080',
            allowOutsideClick: false,
            preConfirm: () => {
                var generatedPIN = Math.floor(100000 + Math.random() * 900000).toString();
                sendEmail(generatedPIN, recordID, userID);
                return generatedPIN;
            }
        }).then((result) => {
            if (result.dismiss === Swal.DismissReason.cancel) {
                Swal.fire('Action Failed', 'No PIN was generated.', 'error');
            } else if (result.value) {
                var generatedPIN = result.value;
                Swal.fire({
                    type: 'info',
                    title: 'PIN Sent',
                    text: 'Check your email',
                    input: 'text',
                    inputAttributes: {
                        inputmode: 'numeric',
                        pattern: '[0-9]*'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Confirm',
                    cancelButtonText: 'Cancel',
                    cancelButtonColor: '#808080',
                    allowOutsideClick: false,
                    preConfirm: (enteredPIN) => {
                        if (enteredPIN === generatedPIN) {
                            window.location.href = '/download/abstract/' + recordID;
                            Swal.fire({
                                title: 'Approval Success',
                                text: 'Your file is ready to download!',
                                type: 'success',
                                confirmButtonText: 'OK',
                            });
                        } else {
                            Swal.showValidationMessage('Invalid PIN');
                        }
                    }
                });
            }
        });
        const confirmButton = document.querySelector('.swal2-confirm');
        const cancelButton = document.querySelector('.swal2-cancel');
        if (confirmButton && cancelButton) {
            confirmButton.classList.add('swal2-styled');
            cancelButton.classList.add('swal2-styled');
        }
    });

    $(".view").on("click", function(){
        Swal.fire({
            title: 'Send Request to Download Abstract',
            text: 'To download {{ record.title }}, please click the "Send Request" button to ask for permission. Once approved, you will be notified through your email account.',
            type: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Send Request'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    "headers": { "X-CSRFToken": '{{ csrf_token }}' },
                    "type": "post",
                    "data": {
                        sendRequest: true,
                        recordId: '{{ record.pk }}',
                        userId: '{{ user.pk }}'
                    },
                    "success": function(data){
                    },
                    "error": function(data){
                        alert("error");
                    }
                });
                Swal.fire(
                    'Request Sent!',
                    'You will be notified upon approval.',
                    'success'
                ).then((result) => {
                    window.location.reload();
                });
            }
        });
    });

   // JavaScript for Toggle Buttons
$('#citeButton').click(function() {
    // Toggle the visibility of the chatbot interface
    document.body.classList.toggle("show-chatbot");
    // Show Cite Prompt and hide Summarize Prompt
    document.getElementById("citePrompt").style.display = "block";
    document.getElementById("summarizePrompt").style.display = "none";
});

$('#summarizeButton').click(function() {
    // Toggle the visibility of the chatbot interface
    document.body.classList.toggle("show-chatbot");
    // Show Summarize Prompt and hide Cite Prompt
    document.getElementById("citePrompt").style.display = "none";
    document.getElementById("summarizePrompt").style.display = "block";
});




    $("#btn-uploads-back").on("click", function(){
        $("#uploads").show();
        $("#uploads-title").hide();
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function sendEmail(pin, recordID, userID) {
        const csrftoken = getCookie('csrftoken');
        const data = {
            pin: pin,
            record_id: recordID,
            user_id: userID
        };
        $.ajax({
            type: 'POST',
            url: '/generate-pin-and-save/',
            data: data,
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
            },
            success: function(response) {
                console.log('Email sent successfully!');
            },
            error: function(xhr, status, error) {
                console.error('Failed to send email:', error);
            }
        });
    }
});

function toggleChatbotPopup() {
						var popup = document.getElementById("chatbot-popup");
						if (popup.style.display === "none" || popup.style.display === "") {
							popup.style.display = "block";
						} else {
							popup.style.display = "none";
						}
					}

          

    function toggleSummaryModal() {
        $('#nalcSummaryModal').modal('toggle');
    }

    function toggleSummaryPopup() {
    var summaryPopup = document.getElementById("summary-popup");
    if (summaryPopup.style.display === "none" || summaryPopup.style.display === "") {
        summaryPopup.style.display = "block";
        summaryPopup.style.opacity = "1";
        summaryPopup.style.transform = "scale(1)";
        summaryPopup.style.animation = "popupAnimation 0.5s forwards";
    } else {
        summaryPopup.style.opacity = "0";
        summaryPopup.style.transform = "scale(0)";
        summaryPopup.style.animation = "none";
        setTimeout(function() {
            summaryPopup.style.display = "none";
        }, 500); // Ensure this matches the duration of the animation
    }
}


</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-9">
            <div class="text-primary text-bold h2">Published Record</div>
        </div>
        <div class="col-3 action-buttons">
            {% if download_approval %}
                <a href="#" data-record-id="{{ record.id }}" data-user-id="{{ user.id }}" data-role-id="{{ role.id }}"><button class="btn base-btn base-bg-primary">Download Paper - {{ record.abstract_filesize|filesizeformat }}</button></a>
            {% else %}
                {% if download_request_sent %}
                    <div class="tooltip-wrapper" data-toggle="tooltip" title="Users can only edit if status is set to removable"><a href="#" class="view request-download-btn" data-record-id="{{ record.id }}" data-user-id="{{ user.id }}" data-role-id="{{ role.id }}"><button class="btn base-btn float-right base-bg-secondary" disabled>Send download request</button></a></div>
                {% else %}
                    <a href="#"><button class="btn base-btn float-right base-bg-secondary">Send download request </button></a>
                {% endif %}
            {% endif %}
            <!-- "Cite" button -->
            <a href="#" id="citeButton"><button class="btn base-btn float-right base-bg-secondary">Cite</button></a>
            <a href="javascript:void(0);" id="summarizeButton"><button class="btn base-btn float-left base-bg-secondary">Summarize</button></a>
        </div>
    </div>
    <div class="row ml-0 mt-2">
        <div class="text-primary h5">{{ record.record_type }} |&nbsp</div>
        <div class="h5 text-bold"> " {{ record.title }} "</div>
    </div> 
    <hr>
    <div id="record-info-container">
        <div class="row ml-0">
            <div class="col-6">
                <div class="row mb-1"><div class="text-bold">Authors:&nbsp</div>{% for author in record.author_set.all %} {{ author.name }} {% if not forloop.last %},&nbsp;{% endif %} {% endfor %}</div>
                <div class="row mb-1"><div class="text-bold">Year:&nbsp </div>{{ record.year_accomplished }}&nbsp - &nbsp {{ record.year_completed }}</div>
                <div class="row mb-1"><div class="text-bold">Adviser:&nbsp</div>{{ record.adviser }}</div>
                <div class="row mb-1"><div class="text-bold">Representative:&nbsp</div>{{ record.representative }}</div>
                <div class="row mb-1"><div class="text-bold">Date Submitted:&nbsp</div>{{ record.date_created }}</div>
            </div>
            <div class="col-6">
                <div class="doc-tags float-right" id="doc-tags">
                    <div class="text-bold">Record Tags:&nbsp</div>
                    <div class="form-check mt-1 mb-1">
                        <input type="checkbox" class="form-check-input " id="ip" disabled{% if record.is_ip %} checked {% endif %}>
                        <label class="form-check-label" for="ip">Intellectual Property</label>
                    </div>
                    <div class="form-check mb-1">
                        <input type="checkbox" class="form-check-input" id="commercialization" disabled {% if record.for_commercialization %} checked {% endif %}>
                        <label class="form-check-label" for="commercialization">For Commercialization</label>
                    </div>
                    <div class="form-check mb-1">
                        <input type="checkbox" class="form-check-input" id="community-ext" disabled {% if record.community_extension %} checked {% endif %}>
                        <label class="form-check-label" for="community-ext">Community Extension</label>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="abstract-preview">
                        <div class="text-bold mb-1">Abstract:</div>
                        {{ record.abstract|safe }}
                    </div>
                </div>
     
        
      
            </div>
        </div>


 
    </div>
</div>

<!-- Chatbot Frontend -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google Fonts Link For Icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />

<style>
    /* Customize the appearance here */
    .message-container {
        display: flex;
        align-items: center; /* Align the items vertically */
    }

    .material-symbols-outlined {
        margin-right: 10px; /* Add space between icon and text */
    }
</style>
<button class="chatbot-toggler">
    <span class="material-symbols-rounded">mode_comment</span>
    <span class="material-symbols-outlined">close</span>
</button>
<div class="chatbot">
    <header>
        <h2>IPAMS Chatbot</h2>
        <span class="close-btn material-symbols-outlined">close</span>
    </header>
    <ul class="chatbox">
        <!-- Cite Prompt -->
        <li class="chat incoming" id="citePrompt" style="display: none;">
            <div class="message-container">
                <span class="material-symbols-outlined">smart_toy</span>
                <p>Hello! ðŸ‘‹<br>What Research Title do you need to Cite?</p>
            </div>
        </li>
        <!-- Summarize Prompt -->
        <li class="chat incoming" id="summarizePrompt" style="display: none;">
            <div class="message-container">
                <span class="material-symbols-outlined">smart_toy</span>
                <p>Hello! ðŸ‘‹<br>What Research Title do you need to Summarize?</p>
            </div>
        </li>
    </ul>
    <div class="chat-input">
        <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
        <span id="send-btn" class="material-symbols-rounded">send</span>
    </div>
</div>




  <!-- Backend of CHATBOT -->
  <script>
    const chatbotToggler = document.querySelector(".chatbot-toggler");
    const closeBtn = document.querySelector(".close-btn");
    const chatbox = document.querySelector(".chatbox");
    const chatInput = document.querySelector(".chat-input textarea");
    const sendChatBtn = document.querySelector(".chat-input span");

    let userMessage = null; // Variable to store user's message
    const API_KEY ="sk-proj-WCJmvQXGaYNCXtuPpIVxT3BlbkFJQk1vuhDicgsTlkhYh1n6";
    
    
    const inputInitHeight = chatInput.scrollHeight;

    const createChatLi = (message, className) => {
        // Create a chat <li> element with passed message and className
        const chatLi = document.createElement("li");
        chatLi.classList.add("chat", `${className}`);
        let chatContent = className === "outgoing" ? `<p></p>` : `<span class="material-symbols-outlined">smart_toy</span><p></p>`;
        chatLi.innerHTML = chatContent;
        chatLi.querySelector("p").textContent = message;
        return chatLi; // return chat <li> element
    }

    const generateResponse = (chatElement) => {
        const API_URL = "https://api.openai.com/v1/chat/completions";
        const messageElement = chatElement.querySelector("p");

        // Define the properties and message for the API request
        const requestOptions = {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{role: "user", content: userMessage}],
            })
        }

        // Send POST request to API, get response and set the reponse as paragraph text
        fetch(API_URL, requestOptions).then(res => res.json()).then(data => {
            messageElement.textContent = data.choices[0].message.content.trim();
        }).catch(() => {
            messageElement.classList.add("error");
            messageElement.textContent = "Oops! Something went wrong. Please try again.";
        }).finally(() => chatbox.scrollTo(0, chatbox.scrollHeight));
    }

    const handleChat = () => {
        userMessage = chatInput.value.trim(); // Get user entered message and remove extra whitespace
        if(!userMessage) return;

        // Clear the input textarea and set its height to default
        chatInput.value = "";
        chatInput.style.height = `${inputInitHeight}px`;

        // Append the user's message to the chatbox
        chatbox.appendChild(createChatLi(userMessage, "outgoing"));
        chatbox.scrollTo(0, chatbox.scrollHeight);
        
        setTimeout(() => {
            // Display "Thinking..." message while waiting for the response
            const incomingChatLi = createChatLi("Thinking...", "incoming");
            chatbox.appendChild(incomingChatLi);
            chatbox.scrollTo(0, chatbox.scrollHeight);
            generateResponse(incomingChatLi);
        }, 600);
    }

    chatInput.addEventListener("input", () => {
        // Adjust the height of the input textarea based on its content
        chatInput.style.height = `${inputInitHeight}px`;
        chatInput.style.height = `${chatInput.scrollHeight}px`;
    });

    chatInput.addEventListener("keydown", (e) => {
        // If Enter key is pressed without Shift key and the window 
        // width is greater than 800px, handle the chat
        if(e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
            e.preventDefault();
            handleChat();
        }
    });

    sendChatBtn.addEventListener("click", handleChat);
    closeBtn.addEventListener("click", () => document.body.classList.remove("show-chatbot"));
    chatbotToggler.addEventListener("click", () => document.body.classList.toggle("show-chatbot"));

  </script>



</div>

</div>
</div>




{% endblock %}

